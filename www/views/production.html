<script src="/static/js/jquery.colorPicker.js"></script>
<script type="text/javascript">
var validator, cur_prj;
$(document).ready(function() {
  loadProjectsList("projectsList");
  $('.rapidsearch').keyup(function () {
    var list = this.id.substr(3);
    var currenttext = $(this).val().toLowerCase();
    if (currenttext == "") {
      resetvisibility($('#' + list + 'List li'));
      return;
    }
    filterlist($('#' + list + 'List li'), currenttext);
  });

  $("#btnreset").click(function() {
    resetProductionForm();
  });

  $("#productionForm").submit(function(event) {
    event.preventDefault();
    if(!validator.form())
      return;
    project.production(cur_prj, "productionForm", resetProductionForm);
    loadProjectsList("projectsList");
  });
  validator = $("#productionForm").validate({
    rules: {
      productionperiod: {
        required: true,
        dateISO: true
      },
      productionbudget: {
        required: true,
        number: true
      },
      productionextra: {
        number:true
      }
    },
    highlight: function (element) {
      $(element).closest('.form-group').addClass('has-error');
    },
    unhighlight: function (element) {
      $(element).closest('.form-group').removeClass('has-error');
    }
  });
});

function loadProjectsList(list) {
  var filter = [{},{name:1}];
  project.load(filter, loadProjects, list);
}

function resetProductionForm()
{
  $("#productionForm")[0].reset();
  $("#projectsList li").removeClass("active");
  $("#economics").html("");
  $("#productionperiod").html("");
}

function loadProjects(data, container) {
  var i;
  var htmllist = "";
  for(i=0;i < data.records.length; i++) {
    htmllist += "<li id='" + data.records[i]._id + "'class='list-group-item'><span class='glyphicon glyphicon-edit'></span> " + data.records[i].name + "</li>";
  }
  $("#" + container).html(htmllist);
  $("#" + container + " .list-group-item").click(function() {
    resetProductionForm();
    $(this).addClass("active");
    if(this.id == "")
      return;
    isupdate = true;
    var filter = [{},{}];
    filter[0]._id = this.id;
    filter[1].economics = 1;
    filter[1].start = 1;
    filter[1].end = 1;
    project.load(filter,loadProjectDetails, container);
  });
}

function loadProjectDetails(data,container) {
  var currentdate = startdate = new Date(data.records[0].start);
  var enddate = new Date(data.records[0].end);
  var htmlselect = "<option value=''></option>";
  for (currentdate = startdate; currentdate < enddate;) {
    htmlselect += "<option value='" + simpleDate(currentdate) + "'>" + currentdate.getMonthName() + " " + currentdate.getFullYear() + "</option>";
    currentdate = new Date(currentdate.setMonth(currentdate.getMonth() + 1));
  }
  var table = generateEconomicsTable(data.records[0].economics);
  $("#economics").html(table);
  cur_prj = {};
  cur_prj._id = data.records[0]._id;
  cur_prj.economics = data.records[0].economics;
  $("#productionperiod").html(htmlselect);
}

function generateEconomicsTable(data) {
  var i, table, period;
  if(!data)
    return "<p>Data not yet available for this project</p>"
  table = "<table class='table table-striped'>";
  table += "<thead><tr><th>Period</th><th>Budget</th><th>Extra</th><th>Note</th><th>Invoiced</th></tr></thead><tbody>";
  for(i=0; i < data.length; i++) {
    period = (new Date(data[i].period)).getMonthName();
    table += "<tr><td>" + period + "</td><td>" + data[i].budget + " &euro;</td><td>" + data[i].extra + " &euro;</td><td>" + data[i].note +  "</td><td>" + data[i].invoiced + " &euro;</td></tr>";
  }
  table += "</tbody></table>";
  return table;
}

//restore visibility for each element in list
function resetvisibility(elem) {
  $(elem).each(function () {
    $(this).removeClass("hidden");
  });
}

function filterlist(list, currenttext) {
  $(list).each(function () {
    var elemname = $(this).text().toLowerCase();
    if (elemname.indexOf(currenttext) != -1)
      $(this).removeClass("hidden");
    else
      $(this).addClass("hidden");
  });
}
</script>
<h2>Projects Management</h2>
<div class="row">
  <div class="col-lg-3">
    <h3>Your projects</h3>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-search"></span>
      <input type="text" class="form-control rapidsearch" placeholder="Rapid Search" id="txtprojects">
    </div>
    <p></p>
    <ul class="list-group" id="projectsList"></ul>
  </div>
  <div class="col-lg-4">
    <h3>Project Details</h3>
    <form class="form-horizontal" role="form" id="productionForm" method="post" action="/index/projects">
      <div class="form-group">
        <label for="productionperiod" class="col-lg-4 control-label">Reference period</label>
        <div class="col-lg-7">
          <select class="form-control" id="productionperiod" name="productionperiod"></select>
        </div>
      </div>
      <div class="form-group">
        <label for="productionbudget" class="col-lg-4 control-label">Budget</label>
        <div class="col-lg-7">
          <div class="input-group">
            <input type="text" class="form-control" id="productionbudget" name="productionbudget" placeholder="8.000">
            <span class="input-group-addon">&euro;</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="productionextra" class="col-lg-4 control-label">Extra</label>
        <div class="col-lg-7">
          <div class="input-group">
            <input type="text" class="form-control" id="productionextra" name="productionextra" placeholder="3.000">
            <span class="input-group-addon">&euro;</span>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="productionnote" class="col-lg-4 control-label">Note</label>
        <div class="col-lg-7">
          <textarea class="form-control" id="productionnote" name="productionnote" rows="3" placeholder="Description"></textarea>
        </div>
      </div>
      <div class="form-group">
        <div class="col-lg-offset-4 col-lg-7">
          <button type="submit" class="btn btn-primary" id="btnsubmit"><span class="glyphicon glyphicon-edit"></span> Save</button>
          <button type="reset" class="btn" id="btnreset"> Reset</button>
        </div>
      </div>
    </form>
  </div>
  <div class="col-lg-5">
    <h3>Project status</h3>
    <div id="economics"></div>
  </div>
</div>
