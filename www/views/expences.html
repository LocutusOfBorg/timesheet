<script type="text/javascript">
var elemnum = 1;
var totals = new Array();
$(document).ready(function() {
  $(".datepicker").datepicker();
  $(".datepicker").datepicker("option", "dateFormat", "yy-mm-dd");

  generateSelect($("select[name='expcategory']"));

  $("#exptable tbody tr td:last").click(function() {
    edittableline(this);
  });
});

function edittableline(cell) {
  computetotal();
  if(cell.textContent.startsWith("Add")) {
    cell.innerHTML = 'Remove <span class="glyphicon glyphicon-minus"></span>'
    $("#exptable tbody").append(addtableline(++elemnum));
    generateSelect($("#exptable tbody tr:last select[name='expcategory']"));
    $("#exptable tbody tr:last .datepicker").datepicker();
    $("#exptable tbody tr:last .datepicker").datepicker("option", "dateFormat", "yy-mm-dd");
    $("#exptable tbody tr td:last").click(function() {
      edittableline(this);
    });
  }
  else
    removetableline(cell.parentNode);
}

function removetableline(row) {
  $(row).remove();
}

function computetotal() {
//scan table
  var i, tfoot = "<tr><td>Total by cat</td>";
  for(i = 0; i < expcategories.length; i++) {
    totals[i] = 0;
  }
  $("#exptable tbody tr").each(function() {
    totals[Number($(this).find("select").val())] += parseFloat($(this).find("input[name='expamount']").val());
  });
  for (i = 1; i < expcategories.length; i++) {
    tfoot += "<td>" + expcategories[i] + ": " + totals[i] + "</td>";
  }
  tfoot += "<td></td><td></td><td></td><td></td><tr>"
  $("#exptable tfoot").html(tfoot);
}

function addtableline(index) {
  var newline = '<tr><td>' + index + '</td><td><input type="text" class="form-control datepicker" name="expdate" placeholder="2013-01-01"></td><td><input type="text" class="form-control" name="expcity" placeholder="City"></td><td><div class="col-lg-12 input-group"><input type="text" class="form-control" name="expamount"><span class="input-group-addon">&euro;</span></div></td><td><select class="form-control" name="expcategory"></select></td><td><input type="text" class="form-control" name="expdescription" placeholder="Note"></td><td><input type="checkbox" name="exppaidby"></td><td><input type="file" name="expfile"></td><td>Add <span class="glyphicon glyphicon-plus"></span></td></tr>';
  return newline;
}

function generateSelect(ref) {
  var htmlcat = "";
  for(i=1; i < expcategories.length; i++) {
    htmlcat += "<option value='" + i + "'>" + expcategories[i] + "</option>";
  }
  $(ref).html(htmlcat);
}
</script>
<h2>New expences</h2>
<div class="row">
  <p>Inserisci gli scontrini relativi alla richiesta di trasferta n&deg;123 del 1/8/2013</p>
  <p>Le spese verranno addebitate sulla commessa </p>
  <table class="table table-striped table-condensed" id="exptable">
    <thead>
      <tr><th>#</th><th>Date</th><th>City</th><th>Amount</th><th>Category</th><th>Description</th><th>Paid by company</th><th>Receipt</th><th></th></tr>
    </thead>
    <tfoot></tfoot>
    <tbody>
      <tr>
        <td>1</td>
        <td><input type="text" class="form-control datepicker" name="expdate" placeholder="2013-01-01"></td>
        <td><input type="text" class="form-control" name="expcity" placeholder="City"></td>
        <td><div class="col-lg-12 input-group"><input type="text" class="form-control" name="expamount"><span class="input-group-addon">&euro;</span></div></td>
        <td><select class="form-control" name="expcategory"></select></td>
        <td><input type="text" class="form-control" name="expdescription" placeholder="Note"></td>
        <td><input type="checkbox" name="exppaidby"></td>
        <td><input type="file" name="expfile"></td>
        <td>Add <span class="glyphicon glyphicon-plus"></span></td>
      </tr>
    </tbody>
  </table>
</div>
