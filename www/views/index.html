<script type="text/javascript">
var cur_trips, trip_id, cur_expences, cur_id, motivation;
var labels = ["from","city","country","start","end","description","accommodation"];
$(document).ready(function() {
  user.me(userdata);
  $("#btnreject").click(function() {
    motivation = $("#note").val();
    if($('#reject .modal-title:contains("trip")').length == 1) {
      updateTripStatus(cur_id, 1, motivation);
    } else {
      updateExpenceStatus(cur_id, 1, motivation);
    }
    $("#note").val("");
    $('#reject').modal('hide');
  });
});

function userdata(data){
  me = data;
  if(me.group != "employee") {
    var filter = [ { 'responsible._id' : me._id }, { name: 1 }, { name: 1 } ];
    project.load(filter, nop ,"");
    filter = [ {}, {name:1, surname:1}, {surname:1}];
    user.load(filter, secondstage , "");
  }
}

function secondstage() {
  loadTripsList("tripreq");
  loadExpencesList("expreq")
  $("#pm").removeClass("hidden");
}

function loadExpencesList(list) {
 var filter = { start:"2013-01-01", end:"2014-12-31", status:[3], responsible_id: me._id };
  expence.load(filter, loadExpences, list);
}

function loadExpences(data, container) {
  var i,j;
  var username, name, total, htmllist = "";
  cur_expences = data;
  for(i=0;i < data.length; i++) {
      total = computeExpenceTotal(data[i].objects);
      name = project.getname(data[i].project_id);
      username = user.getname(data[i].user_id);
      htmllist += "<li id='" + data[i]._id + "'class='list-group-item'><span class='glyphicon glyphicon-list-alt'></span> <b>Project:</b> " + name + " <button data-toggle='popover' type='button' class='btn btn-default btn-sm'><span class='glyphicon glyphicon-info-sign'></span>  Details</button> <button type='button' class='btn btn-success btn-sm'><span class='glyphicon glyphicon-thumbs-up'></span>  Accept</button>  <button type='button' class='btn btn-danger btn-sm'><span class='glyphicon glyphicon-thumbs-down'></span>  Reject</button><p><span class='glyphicon glyphicon-user'></span> <b>User:</b> " + username + "<br/><span class='glyphicon glyphicon-tasks'></span> <b>Grand Total:</b> " + total + "&euro;<br/>";
      if(data[i].file) {
        htmllist += "<span class='glyphicon glyphicon-file'></span> <b>Global receipt file:</b> <a href='/file/download/" + data[i].file._id + "'>" + data[i].file.name + "</a>";
      }
      htmllist += "</p><div class='details hidden'></div></li>";
  }
  $("#" + container).html(htmllist);
  $("#" + container + " .list-group-item button.btn-default").click(function() {
    var curid = $(this).parent().attr("id");
    if($(this).parent().find(".details").hasClass("hidden"))
      generateExpencesDetails(curid, $(this).parent().find(".details"));
    $(this).parent().find(".details").toggleClass("hidden");
  });
  $("#" + container + " .list-group-item button.btn-success").click(function() {
    cur_id = $(this).parent().attr("id");
    updateExpenceStatus(cur_id, 4, "");
  });
  $("#" + container + " .list-group-item button.btn-danger").click(function() {
    cur_id = $(this).parent().attr("id");
    $('#reject .modal-title').text("Reject expence request");
    $('#reject').modal('show');
  });
}

function generateExpencesDetails(id, container) {
  var row,j,html = '<table class="table table-striped table-condensed">';
  html += '<thead><tr><th>Date</th><th>City</th><th>Amount</th><th>Category</th><th>Description</th><th>Paid by</th><th>Invoice</th><th>Receipt</th></thead><tbody>';
  var element = findExpence(id);
  for(j=0; j<element.objects.length; j++) {
    row = element.objects[j];
    html += '<tr><td>' + row.date +'</td><td>' + row.city + '</td><td>' + row.amount+ '&euro;</td><td>' + expcategories[row.category] + '</td><td>' + row.description +'</td><td>';
    if(row.paidby)
      html += 'Company</td><td>';
    else
      html += 'User</td><td>';
    if(row.invoice)
      html += 'Yes</td><td>';
    else
      html += 'No</td><td>';
//add column for file download
    if(row.file) {
      html += '<a href="/file/download/' + row.file._id + '">' + row.file.name + '</a><td>';
    } else {
      html += '</td>';
    }
    html += '</tr>';
  }
  html += "</tbody></table>";
  $(container).html(html);
}

function updateExpenceStatus(id, status, motivation) {
  var selexp = findExpence(id);
  var prj = [{}];
  prj[0]._id = selexp.project_id;
  selexp.status = status;
  selexp.note = motivation;
  delete selexp.project_id;
  prj[0].expences = new Array();
  prj[0].expences[0] = {};
  prj[0].expences[0] = selexp;
  expence.updatestatus(prj, removeElement);
}

function computeExpenceTotal(array) {
  var j,total=0;
  for(j=0; j<array.length; j++) {
    total += array[j].amount;
  }
  return total;
}

function loadTripsList(list) {
 var filter = { start:"2013-01-01", end:"2014-12-31", status:[3], responsible_id: me._id };
  trip.load(filter, loadTrips, list);
}

function loadTrips(data, container) {
  var i,j;
  var htmllist = "";
  cur_trips = data;
  for(i=0;i < data.length; i++) {
      htmllist += "<li id='" + data[i]._id + "'class='list-group-item'><span class='glyphicon glyphicon-edit'></span> " + data[i].city + " " + data[i].start + " <button data-toggle='popover' type='button' class='btn btn-default btn-sm'><span class='glyphicon glyphicon-info-sign'></span>  Details</button> <button type='button' class='btn btn-success btn-sm'><span class='glyphicon glyphicon-thumbs-up'></span>  Accept</button>  <button type='button' class='btn btn-danger btn-sm'><span class='glyphicon glyphicon-thumbs-down'></span>  Reject</button></li>";
  }
  $("#" + container).html(htmllist);
  $("#" + container + " .list-group-item button.btn-default").each(function() {
    var curid = $(this).parent().attr("id");
    $(this).popover({
        html: true,
        placement: 'top',
        content: generateTripPopover(curid, cur_trips),
    });
  });
  $("#" + container + " .list-group-item button.btn-success").click(function() {
    cur_id = $(this).parent().attr("id");
    updateTripStatus(cur_id, 4, "");
  });
  $("#" + container + " .list-group-item button.btn-danger").click(function() {
    cur_id = $(this).parent().attr("id");
    $('#reject .modal-title').text("Reject trip request");
    $('#reject').modal('show');
  });
}

function findExpence(id) {
  var i;
  for(i=0; i<cur_expences.length; i++) {
    if(cur_expences[i]._id == id)
      return cur_expences[i];
  }
}

function findTrip(id) {
  var i;
  for(i=0; i<cur_trips.length; i++) {
    if(cur_trips[i]._id == id)
      return cur_trips[i];
  }
}

function updateTripStatus(id, status, motivation) {
  var seltrip = findTrip(id);
  var prj = [{}];
  prj[0]._id = seltrip.project_id;
  seltrip.status = status;
  seltrip.note = motivation;
  delete seltrip.project_id;
  prj[0].trips = new Array();
  prj[0].trips[0] = {};
  prj[0].trips[0] = seltrip;
  trip.updatestatus(prj, removeElement);
}

function removeElement() {
  $("#" + cur_id).remove();
}

function generateTripPopover(id, ctrips) {
  var html = '<dl class="dl-horizontal">';
  var i,j,active;
  for(i=0; i < ctrips.length; i++) {
    if(ctrips[i]._id == id) {
      for(j=0; j<labels.length; j++) {
        key = labels[j];
        if(key=="accommodation") {
          html += '<dt>Services</dt>';
          for(var value in ctrips[i][key]) {
            if(ctrips[i][key][value])
              html += '<span class="icon-' + value + '"></span>';
          }
          html += '</div></dd>';
        } else {
          html += '<dt>' + capFirstLet(key) + '</dt><dd>' + ctrips[i][key] + '</dd>';
        }
      }
      break;
    }
  }
  return html;
}
</script>
<div style="min-height:200px;display:block"></div>
<div id="pm" class="hidden">
<h3>List of trip waiting for approval</h3>
<ul id="tripreq" class="col-lg-5"></ul>
<h3>List of expences waiting for approval</h3>
<ul id="expreq" class="col-lg-7"></ul>
</div>
<div class="modal fade" id="reject" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title"></h4>
        </div>
        <div class="modal-body">
          Motivation:
          <textarea class="form-control" id="note" name="note" rows="3" placeholder="Description"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="btnreject">Reject</button>
        </div>
      </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
  </div><!-- /.modal -->
