<script type="text/javascript">
var cur_user, validator;
$(document).ready(function() {
  loadUsersList("usersList");
  $(".datepicker").datepicker();
  $(".datepicker").datepicker("option", "dateFormat", "yy-mm-dd");
  $('.rapidsearch').keyup(function () {
    var list = this.id.substr(3);
    var currenttext = $(this).val().toLowerCase();
    if (currenttext == "") {
      resetvisibility($('#' + list + 'List li'));
      return;
    }
    filterlist($('#' + list + 'List li'), currenttext);
  });
  $("#btnreset").click(function() {
    resetUsersForm();
  });
  $("#btnremove").click(function() {
    loadUsersList("usersList");
  });
  $("#userForm").submit(function(event) {
    event.preventDefault();
    if(!validator.form())
      return;
    user.update(cur_user, "userForm",resetUsersForm);
  });
  validator = $("#userForm").validate({
    rules: {
      usernewsalary: {
        required: function(element) {
            if($("#userstart").val() == "")
              return false;
            else
              return true;
        },
        number: true
      },
      userstart: {
        required: function(element) {
            if($("#usernewsalary").val() == "")
              return false;
            else
              return true;
        },
        dateISO: true
      },
    },
    highlight: function (element) {
      $(element).closest('.form-group').addClass('has-error');
    },
    unhighlight: function (element) {
      $(element).closest('.form-group').removeClass('has-error');
    }
  });
});

function loadUsersList(list) {
  var filter = [{},{name:1,surname:1},{surname:1}];
  user.load(filter, loadUsers, list);
}

function createFilterForm(container) {
  var filter = [{},{},{name:1}];
  $("#" + container + " input, #" + container + " select, #" + container + " textarea").each(function (){
    var property = $(this).attr("id").substr(7);
    if (property == "_id")
      return;
    filter[1][property] = 1;
  });
  filter[1].responsible = 1;
  filter[1].employees = 1;
  return filter;
}

function resetUsersForm()
{
  $("#userForm")[0].reset();
  $("#user_id").val(0);
  $("#username").text("");
  $("#userhistory").html("");
  $("#btnsubmit, #btnreset").addClass("hidden");
}

function loadUsers(data, container) {
  var i;
  var htmllist = "";
  for(i=0;i < data.records.length; i++) {
    htmllist += "<li id='" + data.records[i]._id + "'class='list-group-item'><span class='glyphicon glyphicon-user'></span> " + data.records[i].name + " " + data.records[i].surname + "</li>";
  }
  $("#" + container).html(htmllist);
  $("#" + container + " .list-group-item").click(function() {
    var filter = [{},{name:1, surname:1, salary:1, group:1},{surname:1}];
    filter[0]._id = this.id;
    user.load(filter,loadUserDetails, container);
  });
}

function loadUserDetails(data,container) {
  cur_user = data.records[0];
  $("#username").text(data.records[0].name + " " + data.records[0].surname);
  $("#usergroup").val(data.records[0].group);
  $("#userhistory").html(generateSalary(data.records[0].salary));
  addDeleteSalaryEvent();
  $("#btnsubmit, #btnreset").removeClass("hidden");
}

function addDeleteSalaryEvent() {
  $("#userhistory li span:last-child").click(function () {
    var index = $(this).parent().index();
    if (cur_user.salary.length != 1) {
      if(index == 0) {
        cur_user.salary[index + 1].from = cur_user.salary[index].to;
      } else {
        cur_user.salary[index - 1].to = cur_user.salary[index].to;
      }
    }
    cur_user.salary.splice(index,1);
    $("#userhistory").html(generateSalary(cur_user.salary));
    addDeleteSalaryEvent();
  });
}

function generateSalary(salary) {
  var i, htmllist = "";
  if(salary) {
    for(i = 0; i < salary.length; i ++) {
      htmllist += "<li class='list-group-item' id='entry" + i + "'><b>" + salary[i].cost + " &euro;/h </b>  <span>" + salary[i].from + "</span> -- <span>";
      if(salary[i].to == "2099-12-31")
        htmllist += "Now";
      else
        htmllist += salary[i].to;
      htmllist += "</span><span class='glyphicon glyphicon-trash'></span></li>"
    }
  }
  return htmllist;
}

//restore visibility for each element in list
function resetvisibility(elem) {
  $(elem).each(function () {
    $(this).removeClass("hidden");
  });
}

function filterlist(list, currenttext) {
  $(list).each(function () {
    var elemname = $(this).text().toLowerCase();
    if (elemname.indexOf(currenttext) != -1)
      $(this).removeClass("hidden");
    else
      $(this).addClass("hidden");
  });
}
</script>
<h2>Users Management</h2>
<div class="row">
  <div class="col-lg-3">
    <h3>Users list</h3>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-search"></span>
      <input type="text" class="form-control rapidsearch" placeholder="Rapid Search" id="txtusers">
    </div>
    <p></p>
    <ul class="list-group" id="usersList">
  </div>
  <div class="col-lg-5">
    <h3>User Details</h3>
    <form class="form-horizontal" role="form" id="userForm" method="post" action="/index/users">
<input type="hidden" id="user_id" value="0">
<div class="form-group">
  <label for="username" class="col-lg-4 control-label">Name</label>
  <div class="col-lg-6">
    <p id="username" class="form-control-static"></p>
  </div>
</div>
<div class="form-group">
  <label for="usergroup" class="col-lg-4 control-label">Type</label>
  <div class="col-lg-6">
    <select class="form-control" id="usergroup">
      <option value=""></option>
      <option value="employee">Employee</option>
      <option value="administrator">Administrator</option>
      <option value="project manager">Project Manager</option>
      <option value="account">Account</option>
    </select>
  </div>
</div>
<div class="form-group">
  <label for="userhistory" class="col-lg-4 control-label">History</label>
  <div class="col-lg-6">
<ul class="list-group" id="userhistory">
</ul>
  </div>
</div>
<div class="form-group">
  <label for="usernewsalary" class="col-lg-4 control-label">New hour cost</label>
  <div class="col-lg-6">
    <div class="input-group">
      <input type="text" class="form-control" id="usernewsalary" name="usernewsalary" placeholder="20">
      <span class="input-group-addon">&euro;/h</span>
    </div>
  </div>
</div>
<div class="form-group">
  <label for="userstart" class="col-lg-4 control-label">From date</label>
  <div class="col-lg-6">
    <input type="text" class="form-control datepicker" id="userstart" name="userstart" placeholder="2012-03-01">
  </div>
</div>
<div class="form-group">
    <div class="col-lg-offset-4 col-lg-7">
      <button type="submit" class="btn btn-primary hidden" id="btnsubmit"><span class="glyphicon glyphicon-edit"></span> Update</button>
      <button type="reset" class="btn hidden" id="btnreset"> Reset</button>
    </div>
</div>
    </form>
  </div>
</div>
