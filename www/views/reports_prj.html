<!--[if lt IE 9]><script language="javascript" type="text/javascript" src="/static/js/excanvas.js"></script><![endif]-->
<script language="javascript" type="text/javascript" src="/static/js/jquery.jqplot.min.js"></script>
<script type="text/javascript" src="/static/js/plugins/jqplot.dateAxisRenderer.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/jquery.jqplot.min.css" />
<script src="/static/js/bootstrap-switch.js"></script>
<script type="text/javascript">
var validator;
$(document).ready(function() {
  user.me(userdata);
  $(".datepicker").datepicker();
  $(".datepicker").datepicker("option", "dateFormat", "yy-mm-dd");
  $('.rapidsearch').keyup(function () {
    var list = this.id.substr(3);
    var currenttext = $(this).val().toLowerCase();
    if (currenttext == "") {
      resetvisibility($('#' + list + 'List li'));
      return;
    }
    filterlist($('#' + list + 'List li'), currenttext);
  });
  $("#reportstart").change(function() {
    var firstday = new Date($(this).val());
    var lastday = new Date(firstday.getFullYear(), firstday.getMonth() + 1,0);
    $("#reportend").val(simpleDate(lastday));
  });
  $("#btnreset").click(function() {
    resetReportsForm(true);
  });
  tag.load("taglist", 30, false);
  $("#reportForm").submit(function(event) {
    event.preventDefault();
    if(!validator.form())
      return;
    $('#reportwait').modal('show');
    $("div.results").show();
    report.byproject("reportForm", loadReportResults);
  });
  validator = $("#reportForm").validate({
    rules: {
      reportstart: {
        required: true,
        dateISO: true
      },
      reportend: {
        required: true,
        dateISO: true
      }
    },
    highlight: function (element) {
      $(element).closest('.form-group').addClass('has-error');
    },
    unhighlight: function (element) {
      $(element).closest('.form-group').removeClass('has-error');
    }
  });
});

function userdata(data) {
  me = data;
  resetReportsForm();
  loadCustomersList("reportcustomer");
}

function loadProjectsList(list) {
  var filter;
  if(me.group == "project manager" || me.group == "account")
    filter = [{"responsibles._id": me._id},{name:1, description:1},{name:1}];
  else
    filter = [{},{name:1},{name:1}];
  project.load(filter, loadProjects, list);
}

function loadCustomersList(list) {
  var filter = [{},{name:1},{name:1}];
  customer.load(filter, loadCustomers, list);
}

function resetReportsForm(load) {
  if(load == true) {} else {
    loadProjectsList("projectsList");
  }
  $("#projectsList li").removeClass("active");
  $("div.results").hide();
  $("#real").html("");
}

function loadProjects(data, container) {
  var i;
  var htmllist = "";
  for(i=0;i < data.records.length; i++) {
    htmllist += "<li id='" + data.records[i]._id + "'class='list-group-item'><span class='glyphicon glyphicon-edit'></span> " + data.records[i].name + "</li>";
  }
  $("#" + container).html(htmllist);
  $("#" + container + " .list-group-item").click(function() {
    $(this).toggleClass("active");
  });
}

function loadCustomers(data, container) {
  var i;
  var htmlselect = "<option value=''></option>";
  for(i=0;i < data.records.length; i++) {
    htmlselect += "<option value='" + data.records[i]._id + "'>" + data.records[i].name + "</option>";
  }
  $("#" + container).html(htmlselect);
}


function loadReportResults(data) {
/*  if(data.length == 0) {
    showmessage("error", "No project satisfy your search");
  } else {
    $("#real").html("mese: " + data[0][0] + " euro: " + data[0][1]);
  }
*/
  $("#real").html("");
  if($("#reportmode").is(":checked")) {
    //
  } else {
    //for each project
    var i=0,html;
    for(var value in data) {
    //create html container
      $("#real").append('<div id="chartdiv' + i + '" class="singlechart"></div>');
    //create graph
      $("#real").append(createSingleGraph(i, data[value], value));
    //create table
      $("#real").append(createGraphDataTable(i, data[value]));
    //create cleardiv
      $("#real").append('<div class="clearfix"></div>');
      i++;
    }
  }
//  $("#real").html("<div id='chartdiv' style='height:400px;width:300px; '></div>");
//  $.jqplot('chartdiv',  [[[1, 2],[3,5.12],[5,13.1],[7,33.6],[9,85.9],[11,219.9]]]);
  $('#reportwait').modal('hide');
}

function createSingleGraph(index, data, prj_id) {
  var i,salary = [], costs = [], budget = [], extra = [];
  for(i=0; i < data.length; i++) {
    salary.push([data[i][0], -data[i][1].salary]);
  }
  for(i=0; i < data.length; i++) {
    costs.push([data[i][0], -data[i][1].costs]);
  }
  for(i=0; i < data.length; i++) {
    budget.push([data[i][0], data[i][1].budget]);
  }
  for(i=0; i < data.length; i++) {
    extra.push([data[i][0], data[i][1].extra]);
  }
  $.jqplot('chartdiv' + index, [salary, costs, budget, extra],
    {
      title:'Data for ' + project.getname(prj_id),
      // Series options are specified as an array of objects, one object
      // for each series.
      seriesColors: [ g_colorsalary, g_colorcosts, g_colorbugdet, g_colorextra],
      grid:{
        gridLineColor: g_gridLineColor,
        background: g_background,
        borderColor: g_borderColor,
      },
      axes:{
        xaxis:{
          renderer:$.jqplot.DateAxisRenderer,
          tickOptions:{formatString:'%b, %Y'},
          min:$("#reportstart").val(),
          tickInterval:'1 month'
        }
      },
      series:[
          {
            // Change our line width and use a diamond shaped marker.
            lineWidth:2,
            markerOptions: { style:'diamond' }
          },
          {
            // Don't show a line, just show markers.
            // Make the markers 7 pixels with an 'x' style
            showLine:false,
            markerOptions: { size: 7, style:"x" }
          },
          {
            // Use (open) circlular markers.
            markerOptions: { style:"circle" }
          },
          {
            // Use a thicker, 5 pixel line and 10 pixel
            // filled square markers.
            lineWidth:5,
            markerOptions: { style:"filledSquare", size:10 }
          }
      ]
    }
  );
  return "";
}
function createGraphDataTable(index, data) {
  return "";
}
//restore visibility for each element in list
function resetvisibility(elem) {
  $(elem).each(function () {
    $(this).removeClass("hidden");
  });
}

function filterlist(list, currenttext) {
  $(list).each(function () {
    var elemname = $(this).text().toLowerCase();
    if (elemname.indexOf(currenttext) != -1)
      $(this).removeClass("hidden");
    else
      $(this).addClass("hidden");
  });
}
</script>
<h2>Reports</h2>
<div class="row">
  <div class="col-lg-3">
    <h3>Projects list</h3>
    <div class="input-group">
      <span class="input-group-addon glyphicon glyphicon-search"></span>
      <input type="text" class="form-control rapidsearch" placeholder="Rapid Search" id="txtprojects">
    </div>
    <p></p>
    <ul class="list-group" id="projectsList"></ul>
  </div>
  <div class="col-lg-5">
    <h3>Report Details</h3>
    <form class="form-horizontal" role="form" id="reportForm" method="post" action="/index/reports_prj">
<div class="form-group">
    <label for="reportstart" class="col-lg-4 control-label">Date start</label>
    <div class="col-lg-6">
      <input type="text" class="form-control datepicker" id="reportstart" name="reportstart" placeholder="2013-01-01">
    </div>
  </div>
<div class="form-group">
    <label for="reportend" class="col-lg-4 control-label">Date end</label>
    <div class="col-lg-6">
      <input type="text" class="form-control datepicker" id="reportend" name="reportend" placeholder="2020-12-31">
    </div>
  </div>
<div class="form-group">
    <label for="reportproject" class="col-lg-4 control-label">Customer</label>
    <div class="col-lg-6">
      <select class="form-control" id="reportcustomer">
      </select>
    </div>
  </div>
<div class="form-group">
    <label for="reportmode" class="col-lg-4 control-label">Aggregate results</label>
    <div class="col-lg-6">
        <div class="make-switch switch-small" data-on-label="YES" data-off-label="NO">
          <input type="checkbox" name="reportmode" id="reportmode">
        </div>
    </div>
  </div>
<div class="form-group">
    <label for="reporttags" class="col-lg-4 control-label">Tags</label>
    <div class="col-lg-6">
      <ul id="taglist"></ul>
    </div>
  </div>
<div class="form-group">
    <div class="col-lg-offset-4 col-lg-7">
      <button type="submit" class="btn btn-primary" id="btnsubmit"><span class="glyphicon glyphicon-search"></span> Generate</button>
      <button type="reset" class="btn" id="btnreset"> Reset</button>
    </div>
</div>
    </form>
  </div>
</div>
<div class="row results">
<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading">Report results</div>
<div id="real"></div>


</div>
</div>

<div class="modal fade" id="reportwait" data-backdrop="static" data-keyboard="false">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h1>Processing...</h1>
      </div>
      <div class="modal-body">
        <div class="progress progress-striped active">
  <div class="progress-bar"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
  </div>
</div>
      </div>
    </div>
  </div>
</div>
